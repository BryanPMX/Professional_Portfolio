---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Space Invaders - Bryan Perez">
  <div class="min-h-screen py-8 px-6">
    <div class="max-w-6xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold mb-4 text-accent-purple">Space Invaders</h1>
        <p class="text-dark-text-secondary text-lg max-w-2xl mx-auto">
          Classic arcade-style space shooter. Use arrow keys to move and spacebar to shoot. 
          Defend Earth from the alien invasion!
        </p>
      </div>

      <!-- Game Container -->
      <div class="bg-dark-card rounded-xl border border-dark-surface p-6 mb-8">
        <div class="flex justify-center mb-4">
          <canvas 
            id="gameCanvas" 
            width="800" 
            height="600"
            class="border border-dark-surface rounded-lg bg-black max-w-full"
          ></canvas>
        </div>
        
        <!-- Game Controls -->
        <div class="text-center">
          <button 
            id="startBtn"
            class="bg-accent-purple hover:bg-accent-purple-hover text-white px-6 py-2 rounded-lg font-semibold transition-colors mr-4"
          >
            Start Game
          </button>
          <button 
            id="pauseBtn"
            class="bg-dark-surface hover:bg-dark-bg text-dark-text px-6 py-2 rounded-lg font-semibold transition-colors border border-dark-surface"
          >
            Pause
          </button>
        </div>
        
        <!-- Game Stats Display -->
        <div class="flex justify-center mt-4 gap-4">
          <div class="game-stats px-4 py-2 rounded-lg">
            <span class="text-dark-text-secondary">Score: </span>
            <span id="score" class="text-accent-purple font-bold text-lg">0</span>
          </div>
          <div class="game-stats px-4 py-2 rounded-lg">
            <span class="text-dark-text-secondary">Level: </span>
            <span id="level" class="text-accent font-bold text-lg">1</span>
          </div>
          <div class="game-stats px-4 py-2 rounded-lg">
            <span class="text-dark-text-secondary">Health: </span>
            <span id="health" class="text-green-400 font-bold text-lg">3</span>
          </div>
        </div>
      </div>

      <!-- Main Menu Overlay -->
      <div id="mainMenu" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
        <div class="bg-dark-card p-8 rounded-xl border border-accent max-w-md w-full mx-4 text-center">
          <h2 class="text-3xl font-bold text-accent-purple mb-4">Space Invaders</h2>
          <p class="text-dark-text-secondary mb-6">
            Defend Earth from the alien invasion! Shoot all aliens before they reach the bottom.
          </p>
          <div class="space-y-3 mb-6">
            <div class="text-sm text-dark-text-secondary">
              <strong>Controls:</strong><br>
              ← → Arrow Keys to move<br>
              SPACEBAR to shoot
            </div>
            <div class="text-sm text-dark-text-secondary">
              <strong>Objective:</strong><br>
              Destroy all aliens to advance levels!
            </div>
          </div>
          <button
            id="startGameBtn"
            class="bg-accent-purple hover:bg-accent-purple-hover text-white px-8 py-3 rounded-lg font-semibold transition-colors text-lg"
          >
            Start Game
          </button>
        </div>
      </div>

      <!-- Game Over Overlay -->
      <div id="gameOver" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
        <div class="bg-dark-card p-8 rounded-xl border border-accent max-w-md w-full mx-4 text-center">
          <h2 class="text-3xl font-bold text-red-400 mb-4">Game Over!</h2>
          <div class="space-y-2 mb-6">
            <p class="text-dark-text-secondary">Final Score: <span id="finalScore" class="text-accent-purple font-bold text-xl">0</span></p>
            <p class="text-dark-text-secondary">Level Reached: <span id="finalLevel" class="text-accent font-bold text-xl">1</span></p>
            <p class="text-dark-text-secondary">High Score: <span id="finalHighScore" class="text-accent font-bold text-xl">0</span></p>
          </div>
          <div class="flex gap-3 justify-center">
            <button
              id="playAgainBtn"
              class="bg-accent hover:bg-accent-hover text-white px-6 py-2 rounded-lg font-semibold transition-colors"
            >
              Play Again
            </button>
            <button
              id="backToMenuBtn"
              class="bg-dark-surface hover:bg-dark-bg text-dark-text px-6 py-2 rounded-lg font-semibold transition-colors border border-dark-surface"
            >
              Main Menu
            </button>
          </div>
        </div>
      </div>

      <!-- Game Instructions -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
        <div class="bg-dark-surface p-6 rounded-xl border border-dark-surface">
          <h3 class="text-xl font-semibold mb-4 text-accent">How to Play</h3>
          <ul class="space-y-2 text-dark-text-secondary">
            <li class="flex items-center gap-2">
              <span class="w-2 h-2 bg-accent rounded-full"></span>
              Use ← → arrow keys to move your ship
            </li>
            <li class="flex items-center gap-2">
              <span class="w-2 h-2 bg-accent rounded-full"></span>
              Press SPACEBAR to shoot lasers
            </li>
            <li class="flex items-center gap-2">
              <span class="w-2 h-2 bg-accent rounded-full"></span>
              Destroy all aliens to advance levels
            </li>
            <li class="flex items-center gap-2">
              <span class="w-2 h-2 bg-accent rounded-full"></span>
              Don't let aliens reach the bottom!
            </li>
          </ul>
        </div>
        
        <div class="bg-dark-surface p-6 rounded-xl border border-dark-surface">
          <h3 class="text-xl font-semibold mb-4 text-accent-purple">Game Features</h3>
          <ul class="space-y-2 text-dark-text-secondary">
            <li class="flex items-center gap-2">
              <span class="w-2 h-2 bg-accent-purple rounded-full"></span>
              Smooth 60fps animation
            </li>
            <li class="flex items-center gap-2">
              <span class="w-2 h-2 bg-accent-purple rounded-full"></span>
              Collision detection system
            </li>
            <li class="flex items-center gap-2">
              <span class="w-2 h-2 bg-accent-purple rounded-full"></span>
              Progressive difficulty levels
            </li>
            <li class="flex items-center gap-2">
              <span class="w-2 h-2 bg-accent-purple rounded-full"></span>
              Particle effects and animations
            </li>
          </ul>
        </div>
      </div>

      <!-- Navigation -->
      <div class="text-center">
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a 
            href="/games" 
            class="bg-dark-surface hover:bg-dark-bg text-dark-text px-6 py-2 rounded-lg font-semibold transition-colors border border-dark-surface hover:border-accent"
          >
            ← Back to Games
          </a>
          <a 
            href="https://github.com/BryanPMX/space-invaders" 
            target="_blank"
            class="bg-accent hover:bg-accent-hover text-white px-6 py-2 rounded-lg font-semibold transition-colors"
          >
            View Source Code
          </a>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  // Space Invaders Game Implementation - Following Software Engineering Principles

  // Configuration constants - Single Source of Truth
  const SPACE_INVADERS_CONFIG = {
    PLAYER_SPEED: 5,
    PLAYER_HEALTH: 3,
    BULLET_SPEED: 7,
    ALIEN_BULLET_SPEED: 3,
    ALIEN_ROWS: 5,
    ALIEN_SPEED_BASE: 0.5,
    SHOOTING_INTERVAL_MIN: 200, // frames
    SHOOTING_INTERVAL_MAX: 400, // frames
    SHOOTING_RESET_MIN: 400,    // frames
    SHOOTING_RESET_MAX: 1000,   // frames
    EXPLOSION_DURATION: 15,      // frames
    PARTICLE_COUNT: 20,
    STAR_COUNT: 100,
    GAME_STATES: {
      MENU: 'menu',
      PLAYING: 'playing',
      PAUSED: 'paused',
      GAME_OVER: 'gameOver'
    }
  };

  // Game State Manager - State Pattern Implementation
  class SpaceInvadersStateManager {
    constructor(game) {
      this.game = game;
      this.currentState = SPACE_INVADERS_CONFIG.GAME_STATES.MENU;
      this.states = {
        [SPACE_INVADERS_CONFIG.GAME_STATES.MENU]: new SpaceInvadersMenuState(),
        [SPACE_INVADERS_CONFIG.GAME_STATES.PLAYING]: new SpaceInvadersPlayingState(),
        [SPACE_INVADERS_CONFIG.GAME_STATES.PAUSED]: new SpaceInvadersPausedState(),
        [SPACE_INVADERS_CONFIG.GAME_STATES.GAME_OVER]: new SpaceInvadersGameOverState()
      };
    }

    setState(state) {
      if (this.states[state]) {
        this.currentState = state;
        this.states[state].enter(this.game);
      }
    }

    getCurrentState() {
      return this.currentState;
    }
  }

  // Abstract State Class - Template Method Pattern
  class SpaceInvadersGameState {
    enter(game) { /* Override in subclasses */ }
    update(game) { /* Override in subclasses */ }
    handleInput(game, key) { /* Override in subclasses */ }
  }

  class SpaceInvadersMenuState extends SpaceInvadersGameState {
    enter() {
      document.getElementById('mainMenu').classList.remove('hidden');
      document.getElementById('gameOver').classList.add('hidden');
    }
  }

  class SpaceInvadersPlayingState extends SpaceInvadersGameState {
    update(game) {
      game.updateGameLogic();
    }

    handleInput(game, key) {
      game.handleGameInput(key);
    }
  }

  class SpaceInvadersPausedState extends SpaceInvadersGameState {
    enter() {
      // Handle pause UI
    }
  }

  class SpaceInvadersGameOverState extends SpaceInvadersGameState {
    enter(game) {
      SpaceInvadersUIManager.showGameOver(game.score, game.level, Math.max(StorageManager.getHighScore('spaceInvadersHighScore'), game.score));
    }
  }

  // UI Manager for Space Invaders - Single Responsibility for UI operations
  class SpaceInvadersUIManager {
    static showMainMenu() {
      document.getElementById('mainMenu').classList.remove('hidden');
      document.getElementById('gameOver').classList.add('hidden');
    }

    static hideMainMenu() {
      document.getElementById('mainMenu').classList.add('hidden');
    }

    static showGameOver(score, level, highScore) {
      document.getElementById('finalScore').textContent = score;
      document.getElementById('finalLevel').textContent = level;
      document.getElementById('finalHighScore').textContent = highScore;
      document.getElementById('gameOver').classList.remove('hidden');
    }

    static hideGameOver() {
      document.getElementById('gameOver').classList.add('hidden');
    }

    static updateScore(score) {
      document.getElementById('score').textContent = score;
    }

    static updateLevel(level) {
      document.getElementById('level').textContent = level;
    }

    static updateHealth(health) {
      const healthElement = document.getElementById('health');

      // Color code health
      if (health === 3) {
        healthElement.className = 'text-green-400 font-bold text-lg';
      } else if (health === 2) {
        healthElement.className = 'text-yellow-400 font-bold text-lg';
      } else {
        healthElement.className = 'text-red-400 font-bold text-lg';
      }

      healthElement.textContent = health;
    }
  }

  // Input Manager for Space Invaders - Handles all input operations
  class SpaceInvadersInputManager {
    constructor(game) {
      this.game = game;
      this.keys = {};
      this.setupEventListeners();
    }

    setupEventListeners() {
      document.addEventListener('keydown', (e) => this.handleKeyDown(e));
      document.addEventListener('keyup', (e) => this.handleKeyUp(e));
    }

    handleKeyDown(e) {
      this.keys[e.key] = true;

      // Handle spacebar for shooting
      if (e.key === ' ') {
        e.preventDefault();
        if (this.game.stateManager.getCurrentState() === SPACE_INVADERS_CONFIG.GAME_STATES.PLAYING) {
          this.game.shoot();
        }
      }

      // Delegate other input to current state
      if (this.game.stateManager.getCurrentState() === SPACE_INVADERS_CONFIG.GAME_STATES.PLAYING) {
        this.game.stateManager.states[this.game.stateManager.getCurrentState()].handleInput(this.game, e.key);
      }
    }

    handleKeyUp(e) {
      this.keys[e.key] = false;
    }

    isKeyPressed(key) {
      return !!this.keys[key];
    }
  }

  // Storage Manager - Handles localStorage operations (extended for different games)
  class StorageManager {
    static getHighScore(gameKey) {
      return parseInt(localStorage.getItem(gameKey) || '0');
    }

    static setHighScore(gameKey, score) {
      localStorage.setItem(gameKey, score.toString());
    }
  }

  // Main Space Invaders Game Class - Now focused on core game logic
  class SpaceInvaders {
    constructor(canvas) {
      // Validate input parameters
      if (!canvas || !(canvas instanceof HTMLCanvasElement)) {
        throw new Error('Valid canvas element required');
      }

      // Core game properties
      this.canvas = canvas;
      this.ctx = canvas.getContext('2d');
      this.score = 0;
      this.level = 1;

      // Game state - using State pattern
      this.stateManager = new SpaceInvadersStateManager(this);
      this.inputManager = new SpaceInvadersInputManager(this);

      // Enhanced visual elements
      this.particles = [];
      this.stars = [];
      this.explosions = [];
      this.createStarfield();

      // Game entities
      this.player = {
        x: canvas.width / 2 - 25,
        y: canvas.height - 60,
        width: 50,
        height: 30,
        speed: SPACE_INVADERS_CONFIG.PLAYER_SPEED,
        health: SPACE_INVADERS_CONFIG.PLAYER_HEALTH
      };

      this.bullets = [];
      this.aliens = [];
      this.alienBullets = [];
      this.powerUps = [];

      // Initialize game
      this.createAliens();
      this.stateManager.setState(SPACE_INVADERS_CONFIG.GAME_STATES.MENU);
    }

    // UI Management - Delegated to UIManager
    showMainMenu() {
      SpaceInvadersUIManager.showMainMenu();
    }

    hideMainMenu() {
      SpaceInvadersUIManager.hideMainMenu();
    }

    showGameOver() {
      const highScore = StorageManager.getHighScore('spaceInvadersHighScore');
      const finalHighScore = Math.max(highScore, this.score);
      SpaceInvadersUIManager.showGameOver(this.score, this.level, finalHighScore);
    }

    hideGameOver() {
      SpaceInvadersUIManager.hideGameOver();
    }

    setupInput() {
      document.addEventListener('keydown', (e) => {
        this.keys[e.key] = true;
        if (e.key === ' ') {
          e.preventDefault();
          this.shoot();
        }
      });

      document.addEventListener('keyup', (e) => {
        this.keys[e.key] = false;
      });
    }

    createStarfield() {
      this.stars = [];
      for (let i = 0; i < 100; i++) {
        this.stars.push({
          x: Math.random() * this.canvas.width,
          y: Math.random() * this.canvas.height,
          brightness: Math.random(),
          twinkleSpeed: 0.02 + Math.random() * 0.03
        });
      }
    }
    
    createAliens() {
      this.aliens = [];
      const rows = SPACE_INVADERS_CONFIG.ALIEN_ROWS;
      const cols = Math.min(10, 8 + Math.floor(this.level / 2)); // More aliens as level increases
      const alienWidth = 35;
      const alienHeight = 25;
      const spacing = 50;
      const startX = 30;
      const startY = 40;

      for (let row = 0; row < rows; row++) {
        for (let col = 0; col < cols; col++) {
          // Different alien types based on row
          let alienType = 'basic';
          let points = 10;
          let speed = 0.5 + this.level * 0.1;

          if (row === 0) {
            alienType = 'elite';
            points = 30;
            speed = 0.3 + this.level * 0.05;
          } else if (row === 1 || row === 2) {
            alienType = 'advanced';
            points = 20;
            speed = 0.4 + this.level * 0.08;
          }

          this.aliens.push({
            x: startX + col * spacing,
            y: startY + row * spacing,
            width: alienWidth,
            height: alienHeight,
            alive: true,
            type: alienType,
            points: points,
            speed: speed,
            shootTimer: Math.random() * (SPACE_INVADERS_CONFIG.SHOOTING_INTERVAL_MAX - SPACE_INVADERS_CONFIG.SHOOTING_INTERVAL_MIN) + SPACE_INVADERS_CONFIG.SHOOTING_INTERVAL_MIN,
            animationFrame: 0
          });
        }
      }
    }
    
    shoot() {
      if (this.gameRunning) {
        this.bullets.push({
          x: this.player.x + this.player.width / 2 - 2,
          y: this.player.y,
          width: 4,
          height: 10,
          speed: 7
        });
      }
    }
    
    update() {
      if (!this.gameRunning) return;

      // Update stars for twinkling effect
      this.stars.forEach(star => {
        star.brightness += star.twinkleSpeed;
        if (star.brightness > 1 || star.brightness < 0) {
          star.twinkleSpeed *= -1;
        }
      });

      // Update particles
      this.particles = this.particles.filter(particle => {
        particle.x += particle.vx;
        particle.y += particle.vy;
        particle.vy += particle.gravity || 0;
        particle.life--;
        return particle.life > 0;
      });

      // Update explosions
      this.explosions = this.explosions.filter(explosion => {
        explosion.frame++;
        return explosion.frame < explosion.totalFrames;
      });

      // Move player
      if (this.keys['ArrowLeft'] && this.player.x > 0) {
        this.player.x -= this.player.speed;
      }
      if (this.keys['ArrowRight'] && this.player.x < this.canvas.width - this.player.width) {
        this.player.x += this.player.speed;
      }

      // Update bullets
      this.bullets = this.bullets.filter(bullet => {
        bullet.y -= bullet.speed;
        return bullet.y > 0;
      });

      // Update alien bullets
      this.alienBullets = this.alienBullets.filter(bullet => {
        bullet.y += bullet.speed;
        return bullet.y < this.canvas.height;
      });

      // Update aliens with enhanced movement and shooting
      let moveDown = false;
      let direction = 1;

      this.aliens.forEach(alien => {
        if (alien.alive) {
          alien.animationFrame += 0.1;

          // Check if alien should move down
          if (alien.x <= 0 || alien.x >= this.canvas.width - alien.width) {
            moveDown = true;
          }

          // Alien shooting logic
          alien.shootTimer--;
          if (alien.shootTimer <= 0 && alien.y > 50) {
            this.alienShoot(alien);
            alien.shootTimer = Math.random() * (SPACE_INVADERS_CONFIG.SHOOTING_RESET_MAX - SPACE_INVADERS_CONFIG.SHOOTING_RESET_MIN) + SPACE_INVADERS_CONFIG.SHOOTING_RESET_MIN;
          }
        }
      });

      this.aliens.forEach(alien => {
        if (alien.alive) {
          if (moveDown) {
            alien.y += 15 + this.level * 2;
          } else {
            alien.x += direction * alien.speed;
          }
        }
      });

      // Update power-ups
      this.powerUps = this.powerUps.filter(powerUp => {
        powerUp.y += 2;
        return powerUp.y < this.canvas.height;
      });

      // Check collisions
      this.checkCollisions();

      // Check win/lose conditions
      const aliveAliens = this.aliens.filter(alien => alien.alive);
      if (aliveAliens.length === 0) {
        this.nextLevel();
      }

      if (aliveAliens.some(alien => alien.y + alien.height >= this.player.y)) {
        this.playerHit();
      }

      // Check if player is hit by alien bullets
      this.alienBullets.forEach(bullet => {
        if (this.checkCollision(bullet, this.player)) {
          this.playerHit();
        }
      });
    }
    
    alienShoot(alien) {
      this.alienBullets.push({
        x: alien.x + alien.width / 2 - 2,
        y: alien.y + alien.height,
        width: 4,
        height: 8,
        speed: 3 + Math.random() * 2,
        color: '#ff6b6b'
      });
    }

    playerHit() {
      this.player.health--;
      this.createExplosion(this.player.x + this.player.width/2, this.player.y + this.player.height/2, '#ff4444');

      if (this.player.health <= 0) {
        this.gameOver();
      } else {
        // Reset player position briefly
        this.player.x = this.canvas.width / 2 - 25;
      }
    }

    createExplosion(x, y, color = '#ffaa00') {
      this.explosions.push({
        x: x,
        y: y,
        frame: 0,
        totalFrames: 15,
        color: color
      });

      // Create explosion particles
      for (let i = 0; i < 20; i++) {
        this.particles.push({
          x: x,
          y: y,
          vx: (Math.random() - 0.5) * 10,
          vy: (Math.random() - 0.5) * 10,
          gravity: 0.1,
          life: 60,
          size: Math.random() * 3 + 1,
          color: color
        });
      }
    }

    checkCollision(obj1, obj2) {
      return obj1.x < obj2.x + obj2.width &&
             obj1.x + obj1.width > obj2.x &&
             obj1.y < obj2.y + obj2.height &&
             obj1.y + obj1.height > obj2.y;
    }

    checkCollisions() {
      // Player bullets vs aliens
      this.bullets.forEach((bullet, bulletIndex) => {
        this.aliens.forEach((alien) => {
          if (alien.alive && this.checkCollision(bullet, alien)) {
            // Hit!
            alien.alive = false;
            this.bullets.splice(bulletIndex, 1);
            this.score += alien.points;
            this.updateScore();
            this.createExplosion(alien.x + alien.width/2, alien.y + alien.height/2, this.getAlienColor(alien.type));
          }
        });
      });

      // Player vs power-ups
      this.powerUps.forEach((powerUp, index) => {
        if (this.checkCollision(powerUp, this.player)) {
          this.activatePowerUp(powerUp.type);
          this.powerUps.splice(index, 1);
        }
      });
    }

    getAlienColor(type) {
      switch(type) {
        case 'elite': return '#ef4444';
        case 'advanced': return '#ff8844';
        default: return '#ffaa44';
      }
    }

    activatePowerUp(type) {
      // Power-up effects could be implemented here
      console.log('Power-up activated:', type);
    }
    
    draw() {
      // Clear canvas with space gradient
      const spaceGradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
      spaceGradient.addColorStop(0, '#000011');
      spaceGradient.addColorStop(0.5, '#000033');
      spaceGradient.addColorStop(1, '#000011');
      this.ctx.fillStyle = spaceGradient;
      this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

      // Draw twinkling stars
      this.drawStars();

      // Draw particles
      this.particles.forEach(particle => {
        this.ctx.save();
        this.ctx.globalAlpha = particle.life / 60;
        this.ctx.fillStyle = particle.color;
        this.ctx.beginPath();
        this.ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
        this.ctx.fill();
        this.ctx.restore();
      });

      // Draw explosions
      this.explosions.forEach(explosion => {
        const progress = explosion.frame / explosion.totalFrames;
        const radius = progress * 40;
        const alpha = 1 - progress;

        this.ctx.save();
        this.ctx.globalAlpha = alpha;
        this.ctx.fillStyle = explosion.color;
        this.ctx.beginPath();
        this.ctx.arc(explosion.x, explosion.y, radius, 0, Math.PI * 2);
        this.ctx.fill();

        // Explosion rays
        for (let i = 0; i < 8; i++) {
          const angle = (i / 8) * Math.PI * 2;
          const rayLength = radius * (0.5 + Math.random() * 0.5);
          this.ctx.beginPath();
          this.ctx.moveTo(explosion.x, explosion.y);
          this.ctx.lineTo(
            explosion.x + Math.cos(angle) * rayLength,
            explosion.y + Math.sin(angle) * rayLength
          );
          this.ctx.strokeStyle = explosion.color;
          this.ctx.lineWidth = 2;
          this.ctx.stroke();
        }
        this.ctx.restore();
      });

      // Draw player with enhanced design
      this.drawPlayer();

      // Draw bullets with glow effect
      this.bullets.forEach(bullet => {
        this.ctx.shadowColor = '#8b5cf6';
        this.ctx.shadowBlur = 10;
        this.ctx.fillStyle = '#8b5cf6';
        this.ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
        this.ctx.shadowBlur = 0;
      });

      // Draw alien bullets
      this.alienBullets.forEach(bullet => {
        this.ctx.fillStyle = bullet.color;
        this.ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
      });

      // Draw aliens with different designs based on type
      this.aliens.forEach(alien => {
        if (alien.alive) {
          this.drawAlien(alien);
        }
      });

      // Draw power-ups
      this.powerUps.forEach(powerUp => {
        this.ctx.save();
        this.ctx.shadowColor = powerUp.color;
        this.ctx.shadowBlur = 15;
        this.ctx.fillStyle = powerUp.color;
        this.ctx.fillRect(powerUp.x, powerUp.y, powerUp.width, powerUp.height);
        this.ctx.restore();
      });

      // Draw HUD
      this.drawHUD();
    }

    drawStars() {
      this.stars.forEach(star => {
        this.ctx.save();
        this.ctx.globalAlpha = star.brightness * 0.8;
        this.ctx.fillStyle = '#ffffff';
        this.ctx.beginPath();
        this.ctx.arc(star.x, star.y, 1, 0, Math.PI * 2);
        this.ctx.fill();
        this.ctx.restore();
      });
    }

    drawPlayer() {
      const { x, y, width, height } = this.player;

      // Player ship with gradient
      const shipGradient = this.ctx.createLinearGradient(x, y, x, y + height);
      shipGradient.addColorStop(0, '#4f46e5');
      shipGradient.addColorStop(1, '#3b82f6');

      this.ctx.fillStyle = shipGradient;
      this.ctx.beginPath();
      this.ctx.moveTo(x + width/2, y);
      this.ctx.lineTo(x + width, y + height);
      this.ctx.lineTo(x + width * 0.75, y + height * 0.7);
      this.ctx.lineTo(x + width * 0.25, y + height * 0.7);
      this.ctx.lineTo(x, y + height);
      this.ctx.closePath();
      this.ctx.fill();

      // Engine glow
      this.ctx.shadowColor = '#3b82f6';
      this.ctx.shadowBlur = 20;
      this.ctx.fillStyle = '#60a5fa';
      this.ctx.fillRect(x + width * 0.25, y + height * 0.7, width * 0.5, height * 0.3);
      this.ctx.shadowBlur = 0;
    }

    drawAlien(alien) {
      const { x, y, width, height, type, animationFrame } = alien;

      let color;
      switch(type) {
        case 'elite':
          color = '#ef4444';
          break;
        case 'advanced':
          color = '#f97316';
          break;
        default:
          color = '#eab308';
      }

      // Alien body with animation
      const wobble = Math.sin(animationFrame) * 2;
      this.ctx.fillStyle = color;
      this.ctx.fillRect(x + wobble, y, width, height);

      // Alien eyes
      this.ctx.fillStyle = '#ffffff';
      this.ctx.fillRect(x + 8 + wobble, y + 8, 6, 6);
      this.ctx.fillRect(x + width - 14 + wobble, y + 8, 6, 6);

      // Alien pupils
      this.ctx.fillStyle = '#000000';
      this.ctx.fillRect(x + 10 + wobble, y + 10, 2, 2);
      this.ctx.fillRect(x + width - 12 + wobble, y + 10, 2, 2);
    }

    drawHUD() {
      // Health indicator
      this.ctx.fillStyle = '#ffffff';
      this.ctx.font = '16px monospace';
      this.ctx.fillText(`Health: ${this.player.health}`, 10, 25);
      this.ctx.fillText(`Level: ${this.level}`, 10, 45);
    }
    
    gameLoop() {
      this.update();
      this.draw();
      
      if (this.gameRunning) {
        requestAnimationFrame(() => this.gameLoop());
      }
    }
    
    start() {
      this.player.health = SPACE_INVADERS_CONFIG.PLAYER_HEALTH;
      this.particles = [];
      this.explosions = [];
      this.powerUps = [];
      this.stateManager.setState(SPACE_INVADERS_CONFIG.GAME_STATES.PLAYING);
      this.gameLoop();
    }
    
    pause() {
      this.gameRunning = !this.gameRunning;
      if (this.gameRunning) {
        this.gameLoop();
      }
    }
    
    reset() {
      // Reset game state
      this.score = 0;
      this.level = 1;
      this.player.health = SPACE_INVADERS_CONFIG.PLAYER_HEALTH;
      this.player.x = this.canvas.width / 2 - 25;

      // Reset game entities
      this.bullets = [];
      this.alienBullets = [];
      this.aliens = [];
      this.particles = [];
      this.explosions = [];
      this.powerUps = [];

      // Reset UI
      SpaceInvadersUIManager.updateScore(this.score);
      SpaceInvadersUIManager.updateLevel(this.level);
      SpaceInvadersUIManager.updateHealth(this.player.health);

      // Recreate aliens
      this.createAliens();

      // Return to menu state
      this.stateManager.setState(SPACE_INVADERS_CONFIG.GAME_STATES.MENU);
    }
    
    nextLevel() {
      this.level++;
      this.updateLevel();

      // Level up effects
      this.createExplosion(this.canvas.width/2, this.canvas.height/2, '#00ff00');
      for (let i = 0; i < 50; i++) {
        this.particles.push({
          x: this.canvas.width/2,
          y: this.canvas.height/2,
          vx: (Math.random() - 0.5) * 15,
          vy: (Math.random() - 0.5) * 15,
          gravity: 0.1,
          life: 120,
          size: Math.random() * 4 + 2,
          color: '#00ff88'
        });
      }

      // Reset game state for new level
      this.bullets = [];
      this.alienBullets = [];
      this.powerUps = [];
      this.createAliens();

      // Bonus points for completing level
      this.score += this.level * 100;
      this.updateScore();
    }
    
    gameOver() {
      this.stateManager.setState(SPACE_INVADERS_CONFIG.GAME_STATES.GAME_OVER);

      // Create dramatic game over explosion
      this.createExplosion(this.player.x + this.player.width/2, this.player.y + this.player.height/2, '#ff0000');
      for (let i = 0; i < 100; i++) {
        this.particles.push({
          x: this.player.x + this.player.width/2,
          y: this.player.y + this.player.height/2,
          vx: (Math.random() - 0.5) * 20,
          vy: (Math.random() - 0.5) * 20,
          gravity: 0.2,
          life: 180,
          size: Math.random() * 6 + 3,
          color: '#ff4444'
        });
      }

      // Check and update high score
      const highScore = StorageManager.getHighScore('spaceInvadersHighScore');
      if (this.score > highScore) {
        StorageManager.setHighScore('spaceInvadersHighScore', this.score);
      }

      setTimeout(() => {
        this.showGameOver();
      }, 1000);
    }
    
    updateScore() {
      SpaceInvadersUIManager.updateScore(this.score);
    }

    updateLevel() {
      SpaceInvadersUIManager.updateLevel(this.level);
    }

    updateHealth() {
      SpaceInvadersUIManager.updateHealth(this.player.health);
    }
  }
  
  // Initialize game
  document.addEventListener('DOMContentLoaded', () => {
    const canvas = document.getElementById('gameCanvas');
    const game = new SpaceInvaders(canvas);
    
    document.getElementById('startBtn').addEventListener('click', () => {
      game.start();
    });
    
    document.getElementById('pauseBtn').addEventListener('click', () => {
      game.pause();
    });

    // New menu buttons
    document.getElementById('startGameBtn').addEventListener('click', () => {
      game.start();
    });

    document.getElementById('playAgainBtn').addEventListener('click', () => {
      game.reset();
      game.start();
    });

    document.getElementById('backToMenuBtn').addEventListener('click', () => {
      game.reset();
    });

    // Initial draw
    game.draw();
  });
</script>

<style>
  @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
  }

  @keyframes space-glow {
    0%, 100% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.5); }
    50% { box-shadow: 0 0 50px rgba(59, 130, 246, 0.8); }
  }

  .animate-float {
    animation: float 3s ease-in-out infinite;
  }

  .space-canvas-glow {
    animation: space-glow 3s ease-in-out infinite;
  }

  .game-stats {
    background: linear-gradient(135deg, rgba(15, 15, 15, 0.9), rgba(26, 26, 26, 0.9));
    border: 1px solid rgba(59, 130, 246, 0.3);
    backdrop-filter: blur(10px);
  }
</style>
